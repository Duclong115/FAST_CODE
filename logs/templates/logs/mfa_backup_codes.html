{% extends 'logs/base.html' %}

{% block title %}Backup Codes - SQL Log Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h4><i class="fas fa-key"></i> Backup Codes</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Lưu ý quan trọng:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Mỗi backup code chỉ sử dụng được <strong>một lần</strong></li>
                        <li>Lưu trữ các codes này ở nơi <strong>an toàn</strong></li>
                        <li>Không chia sẻ backup codes với ai khác</li>
                        <li>Nếu mất tất cả backup codes, liên hệ admin để reset MFA</li>
                    </ul>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Danh sách Backup Codes ({{ backup_codes_count }} codes)</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for code in backup_codes %}
                            <div class="col-md-6 mb-2">
                                <div class="input-group">
                                    <span class="input-group-text">{{ forloop.counter|stringformat:"02d" }}</span>
                                    <input type="text" class="form-control font-monospace" value="{{ code }}" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyCode('{{ code }}')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a href="{% url 'logs:mfa_setup' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Quay lại MFA Setup
                    </a>
                    <a href="{% url 'logs:download_backup_codes' %}" class="btn btn-info">
                        <i class="fas fa-download"></i> Tải xuống File TXT
                    </a>
                    <form method="post" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="regenerate_backup_codes">
                        <button type="submit" class="btn btn-warning" onclick="return confirm('Tạo lại backup codes sẽ làm mất hiệu lực các codes cũ. Bạn có chắc chắn?')">
                            <i class="fas fa-redo"></i> Tạo lại Backup Codes
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyCode(code) {
    try {
        navigator.clipboard.writeText(code).then(() => {
            // Show success message
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-secondary');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 2000);
        });
    } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        alert('Đã copy code: ' + code);
    }
}
</script>
{% endblock %}
