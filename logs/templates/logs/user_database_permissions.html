{% extends 'logs/base.html' %}

{% block title %}Phân Quyền Database Của Tôi - SQL Log Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-database"></i> Phân Quyền Database Của Tôi</h2>
            <a href="{% url 'logs:index' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay Lại
            </a>
        </div>
    </div>
</div>

<!-- Thống kê -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_permissions }}</h4>
                        <p class="card-text">Tổng Quyền</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-key fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.active_permissions }}</h4>
                        <p class="card-text">Quyền Hoạt Động</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.expired_permissions }}</h4>
                        <p class="card-text">Quyền Hết Hạn</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.accessible_databases }}</h4>
                        <p class="card-text">Database Truy Cập</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Database có thể truy cập -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Database Có Thể Truy Cập</h5>
            </div>
            <div class="card-body">
                {% if accessible_databases %}
                <div class="row">
                    {% for db in accessible_databases %}
                    <div class="col-md-3 mb-2">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="fas fa-database fa-2x text-success mb-2"></i>
                                <h6 class="card-title">{{ db }}</h6>
                                <a href="{% url 'logs:index' %}?database={{ db }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-eye"></i> Xem Logs
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Chưa có quyền truy cập database nào</h5>
                    <p class="text-muted">Liên hệ quản trị viên để được cấp quyền truy cập.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Chi tiết phân quyền -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-key"></i> Chi Tiết Phân Quyền</h5>
            </div>
            <div class="card-body">
                {% if permissions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Database</th>
                                <th>Loại Quyền</th>
                                <th>Cấp Quyền Bởi</th>
                                <th>Thời Gian Cấp</th>
                                <th>Hết Hạn</th>
                                <th>Trạng Thái</th>
                                <th>Ghi Chú</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for permission in permissions %}
                            <tr>
                                <td>
                                    <strong>{{ permission.database_name }}</strong>
                                </td>
                                <td>
                                    {% if permission.permission_type == 'read' %}
                                    <span class="badge bg-info">Chỉ đọc</span>
                                    {% elif permission.permission_type == 'write' %}
                                    <span class="badge bg-warning">Đọc và ghi</span>
                                    {% elif permission.permission_type == 'admin' %}
                                    <span class="badge bg-danger">Quản trị</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if permission.granted_by %}
                                    {{ permission.granted_by.username }}
                                    {% else %}
                                    <span class="text-muted">Hệ thống</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ permission.granted_at|date:"d/m/Y H:i" }}</small>
                                </td>
                                <td>
                                    {% if permission.expires_at %}
                                    <small>{{ permission.expires_at|date:"d/m/Y H:i" }}</small>
                                    {% else %}
                                    <span class="text-muted">Không hết hạn</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if permission.is_valid %}
                                    <span class="badge bg-success">Hoạt động</span>
                                    {% elif permission.is_expired %}
                                    <span class="badge bg-danger">Hết hạn</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Không hoạt động</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if permission.notes %}
                                    <small>{{ permission.notes|truncatechars:50 }}</small>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-key fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Chưa có phân quyền nào</h5>
                    <p class="text-muted">Liên hệ quản trị viên để được cấp quyền truy cập database.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Hướng dẫn -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Hướng Dẫn</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Quyền Chỉ Đọc:</h6>
                        <ul class="small">
                            <li>Xem logs của database</li>
                            <li>Tạo báo cáo</li>
                            <li>Không thể chỉnh sửa</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>Quyền Đọc và Ghi:</h6>
                        <ul class="small">
                            <li>Tất cả quyền đọc</li>
                            <li>Import logs mới</li>
                            <li>Chỉnh sửa logs</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>Quyền Quản Trị:</h6>
                        <ul class="small">
                            <li>Tất cả quyền trên</li>
                            <li>Xóa logs</li>
                            <li>Quản lý database</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
